<!DOCTYPE html>
<html>
<head>
  <title>Delivery Record</title>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial; background:#f5f5f5; padding:20px; }
    .card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; }
    input { padding:5px; }
    button { padding:5px 10px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    .icon-btn { background:none; border:none; cursor:pointer; font-size:16px; }
    .icon-btn:hover { color:red; }
    .row { display:flex; align-items:center; gap:8px; }
  </style>
</head>

<body>

<h2>Delivery Note</h2>

<div class="card">
  Date:
  <input type="date" id="date">
</div>

<div class="card">
  <input id="shopInput" placeholder="Enter shop">
  <button onclick="addShop()">+ Add Shop</button>
</div>

<div id="shops"></div>

<button onclick="saveAll()">ğŸ’¾ Save</button>
<button onclick="exportPDF()">ğŸ“„ Export PDF</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA89HJ2jqFnxCZWHgxpJ5_FeNxcoq2cmf8",
  authDomain: "delivery-note-test1.firebaseapp.com",
  projectId: "delivery-note-test1",
  storageBucket: "delivery-note-test1.firebasestorage.app",
  messagingSenderId: "797351855470",
  appId: "1:797351855470:web:6492eb7bf1a32e2e0fed7f",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = [];

/* ---------- SHOP ---------- */
window.addShop = () => {
  const name = shopInput.value;
  if (!name) return;
  data.push({ shop: name, suppliers: [] });
  shopInput.value = "";
  render();
};

window.editShop = i => {
  const el = document.getElementById(`shop-${i}`);
  el.disabled = !el.disabled;
  el.focus();
};

window.deleteShop = i => {
  if (!confirm("Delete shop?")) return;
  data.splice(i, 1);
  render();
};

/* ---------- SUPPLIER ---------- */
window.addSupplier = s => {
  const name = prompt("Supplier name:");
  if (!name) return;
  data[s].suppliers.push({ name, items: [] });
  render();
};

window.editSupplier = (s,p) => {
  const el = document.getElementById(`sup-${s}-${p}`);
  el.disabled = !el.disabled;
  el.focus();
};

window.deleteSupplier = (s,p) => {
  if (!confirm("Delete supplier?")) return;
  data[s].suppliers.splice(p,1);
  render();
};

/* ---------- VEG ---------- */
window.addVeg = (s,p) => {
  data[s].suppliers[p].items.push({ veg:"", basket:0, weight:0 });
  render();
};

window.updateVeg = (s,p,i,f,v) => {
  data[s].suppliers[p].items[i][f] = f=="veg"?v:Number(v);
};

window.deleteVeg = (s,p,i) => {
  data[s].suppliers[p].items.splice(i,1);
  render();
};

/* ---------- RENDER ---------- */
function render() {
  const el = document.getElementById("shops");
  el.innerHTML = "";

  data.forEach((shop,s) => {
    let html = `
    <div class="card">
      <div class="row">
        <input id="shop-${s}" value="${shop.shop}" disabled>
        <button class="icon-btn" onclick="editShop(${s})">âœï¸</button>
        <button class="icon-btn" onclick="deleteShop(${s})">ğŸ—‘ï¸</button>
      </div>

      <button onclick="addSupplier(${s})">+ Supplier</button>
    `;

    shop.suppliers.forEach((sup,p) => {
      html += `
      <div class="card">
        <div class="row">
          <input id="sup-${s}-${p}" value="${sup.name}" disabled>
          <button class="icon-btn" onclick="editSupplier(${s},${p})">âœï¸</button>
          <button class="icon-btn" onclick="deleteSupplier(${s},${p})">ğŸ—‘ï¸</button>
        </div>

        <table>
          <tr>
            <th>Veg</th><th>Basket</th><th>Kg</th><th>Total</th><th></th>
          </tr>
      `;

      sup.items.forEach((i,idx) => {
        html += `
        <tr>
          <td><input value="${i.veg}" onchange="updateVeg(${s},${p},${idx},'veg',this.value)"></td>
          <td><input type="number" value="${i.basket}" onchange="updateVeg(${s},${p},${idx},'basket',this.value)"></td>
          <td><input type="number" value="${i.weight}" onchange="updateVeg(${s},${p},${idx},'weight',this.value)"></td>
          <td>${i.basket * i.weight}</td>
          <td><button class="icon-btn" onclick="deleteVeg(${s},${p},${idx})">ğŸ—‘ï¸</button></td>
        </tr>`;
      });

      html += `
        </table>
        <button onclick="addVeg(${s},${p})">+ Add Veg</button>
      </div>`;
    });

    html += "</div>";
    el.innerHTML += html;
  });
}

/* ---------- SAVE ---------- */
window.saveAll = async () => {
  await addDoc(collection(db, "deliveries"), {
    date: document.getElementById("date").value,
    data,
    created: new Date()
  });
  alert("Saved!");
};

/* ---------- PDF EXPORT ---------- */
window.exportPDF = function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 10;
  doc.setFontSize(14);
  doc.text("Delivery Note", 10, y);
  y += 8;

  doc.setFontSize(10);
  doc.text("Date: " + document.getElementById("date").value, 10, y);
  y += 10;

  data.forEach(shop => {
    doc.setFontSize(12);
    doc.text(`Shop: ${shop.shop}`, 10, y);
    y += 6;

    shop.suppliers.forEach(sup => {
      doc.setFontSize(11);
      doc.text(`  Supplier: ${sup.name}`, 10, y);
      y += 6;

      sup.items.forEach(item => {
        const total = item.basket * item.weight;
        doc.text(
          `     - ${item.veg} | ${item.basket} x ${item.weight} = ${total} kg`,
          10,
          y
        );
        y += 5;

        if (y > 280) {
          doc.addPage();
          y = 10;
        }
      });
    });

    y += 6;
  });

  doc.save("delivery-note.pdf");
};
</script>

</body>
</html>
